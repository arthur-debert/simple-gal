# Testing Guide

## Principles

1. **Unit tests for features.** All pipeline logic is pure Rust returning plain data. Test it directly — no shelling out, no filesystem side effects beyond temp dirs.

2. **CLI is a thin shell.** `main()` parses args and dispatches to `scan()`, `process()`, `generate()`. The functions are tested independently; the CLI itself doesn't need integration tests.

3. **Generated HTML via string inspection.** Templates produce `String`s. Test them with substring checks or DOM-like assertions — no browser needed for structural correctness.

4. **Browser tests for layout only.** Headless Chrome verifies CSS behavior (bounding boxes, scroll, viewport adaptation). Don't use it to check page titles or HTML structure.

5. **Image processing: params, not pixels.** Validate the dimensions/operations sent to the backend. A handful of full end-to-end checks confirm the backend works; the rest are unit tests on `calculations.rs` and `operations.rs`.

## Running tests

```bash
cargo test                                          # 253 unit + integration tests
cargo test --test browser_layout -- --ignored       # 12 browser layout tests (needs Chrome)
```

## Shared fixtures

`fixtures/content/` is a single dataset that covers the full feature set. Tests copy it to a temp dir via `setup_fixtures()` so they can't interfere with each other.

```
content/
├── config.toml                         # Root config — overrides ALL defaults
├── 010-Landscapes/                     # Numbered album (in nav)
│   ├── config.toml                     # Per-gallery override (quality, aspect_ratio)
│   ├── description.txt                 # Album description (plain text)
│   ├── 001-dawn.jpg + .txt            # Image with sidecar
│   ├── 002-dusk.jpg                    # Image without sidecar
│   └── 010-night.jpg                   # Non-contiguous numbering
├── 020-Travel/                         # Album group (nested)
│   ├── 010-Japan/                      # description.md + description.txt (md wins)
│   │   └── 001-tokyo.jpg + .txt       # Image with sidecar
│   └── 020-Italy/
│       └── 001-rome.jpg               # No description, no sidecar
├── 030-Minimal/                        # Single image, no extras
│   └── 001-solo.jpg
├── 040-about.md                        # Page (# heading → title)
├── 050-github.md                       # Link page (single URL body)
└── wip-drafts/                         # Unnumbered → hidden from nav
    └── 001-test.jpg
```

See `fixtures/README.md` for the full rationale of each element.

## Test helpers

All helpers live in `src/test_helpers.rs` (compiled only under `#[cfg(test)]`).

### Fixture setup

- **`setup_fixtures()`** — Copies `fixtures/content/` to a temp dir. Returns the `TempDir` (cleaned up on drop).

### Lookups (panic with helpful messages on miss)

- **`find_album(&manifest, "title")`** — Find album by title.
- **`find_image(&album, "slug")`** — Find image by slug within an album.
- **`find_page(&manifest, "slug")`** — Find page by slug.

### Bulk extractors

- **`album_titles(&manifest)`** → `Vec<&str>`
- **`image_titles(&album)`** → `Vec<Option<&str>>`
- **`image_descriptions(&album)`** → `Vec<Option<&str>>`

### Navigation assertions

- **`nav_titles(&manifest)`** → `Vec<&str>` — Top-level nav items.
- **`nav_children_titles(&manifest, "parent")`** → `Vec<&str>` — Children of a nav item.
- **`assert_nav_shape(&manifest, &[("Title", &["child1", "child2"])])`** — Assert the full nav tree in one call.

## Browser tests

`tests/browser_layout.rs` uses `headless_chrome` (CDP) to verify CSS layout against real HTML generated by the full pipeline. Fixtures live in `fixtures/browser-content/` (separate from `content/` because layout tests need specific image dimensions).

The test harness builds fixtures once per run via `OnceLock`, shares a single `Browser` instance, and creates one tab per test for isolation.

Key helpers in the test file: `load_page()`, `load_page_with_viewport()`, `bounding_box()`, `set_viewport()`.
